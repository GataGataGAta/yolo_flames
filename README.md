````markdown
# YOLOv8 クリックアノテーションツール

このツールは、YOLOv8オブジェクト検出を利用して、動画のフレーム内のオブジェクトにアノテーションを付けるためのものです。 フレームの移動、オブジェクトクラスの選択、YOLO形式でのアノテーションの保存を行うための簡単なGUIを提供します。

## 必要なもの

*   Python 3.6以上
*   必要なPythonパッケージ：
    *   opencv-python
    *   imageio
    *   ultralytics
    *   Pillow
    *   tkinter (通常はPythonに付属していますが、システムによっては別途インストールが必要な場合があります)
    *   tqdm

これらのパッケージは、pipを使用してインストールできます。

```bash
pip install opencv-python imageio ultralytics Pillow tqdm
```

## インストール

1. スクリプト `yolo_click.py` をダウンロードします。

## 使い方

1. **スクリプトを実行します：**

   ```bash
   python yolo_click.py demo.mp4
   ```

   `demo.mp4` を、実際の動画ファイルのパスに置き換えてください。

2. **フレームの抽出：**

   * `<video_name>_frames` ディレクトリにフレーム画像が存在しない場合、ツールは動画からフレームを抽出します。
   * ディレクトリにフレーム画像が既に存在する場合、抽出はスキップされます。

3. **アノテーション開始位置：**

   * 初回実行時は、動画内で最初に `person` クラスを検出したフレームからアノテーションを開始します。
   * 中断して再開するときは、保存されている進捗（`progress.json`）の位置から開始します。

4. **アノテーションのプロセス：**

   * GUIウィンドウが表示され、最初のフレームがYOLOv8オブジェクト検出の結果とともに表示されます。
   * 左側にクラスID選択用のコンボボックスがあり、アノテーションしたいクラスIDを選択します。
   * クラスID選択欄の下に「クリック後に次のフレームへ進む」チェックボックスがあり、クリック後に自動的に次のフレームに進むかどうかを切り替えられます。
   * 画像内の検出オブジェクトをクリックすると、対応するYOLO形式のアノテーションと画像が保存されます。
   * 自動進行が有効の場合はクリック後に次のフレームへ移動し、無効の場合は同じフレームに留まります。

5. **キーボードショートカット：**

   * `f` : 次のフレーム
   * `d` : 前のフレーム
   * `s` : クリックしたオブジェクトのラベルを保存
   * `q` : 進捗を保存して終了
   * `w` : 進捗をリセット（`progress.json` を削除）して終了

## 出力：

* アノテーション付きの画像とYOLO形式のラベルファイルは、`output_dataset` ディレクトリに保存され、`train` および `val` サブディレクトリに分割されます。
* バウンディングボックス付きのクリックされた画像は、`output_clicked` ディレクトリに保存されます。
* 進捗情報は `progress.json` に保存され、後から作業を再開できます。

## ディレクトリ構造

ツールは次のディレクトリ構造を作成します。

```
output_dataset/
├── images/
│   ├── train/
│   ├── val/
├── labels/
│   ├── train/
│   ├── val/
output_clicked/
video_name_frames/
progress.json
```

## 設定

* `CLASS_NAMES`: YOLOv8モデル（デフォルトは `yolov8n.pt`）から自動取得されます。
* `BASE_DIR`: 出力データセットのベースディレクトリ（デフォルト：`output_dataset`）。
* `CLICKED_OUTPUT_DIR`: クリックされた画像の保存ディレクトリ（デフォルト：`output_clicked`）。
* `PROGRESS_FILE`: 進捗を保存するJSONファイル（デフォルト：`progress.json`）。

## ヒント

* アノテーション開始位置は、最初に `person` が検出されたフレームからスタートするので、効率的に作業が進められます。
* 「クリック後に次のフレームへ進む」チェックを切り替えて、ゆっくり確認しながらアノテーションするか、連続で素早く作業するか選べます。
* 定期的に `q` キーで進捗を保存しながら作業を続けてください。

## トラブルシューティング

* フレーム抽出に失敗した場合は、動画のコーデックが適切か確認してください。
* GUIが正常に表示されない場合は、PythonのTkinter環境を確認してください。

## クレジット

このツールは、UltralyticsによるYOLOv8オブジェクト検出フレームワークに基づいています。

````

